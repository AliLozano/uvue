#!/usr/bin/env node
/* tslint:disable */

const { exists } = require('fs-extra');
const { resolve } = require('path');
const { Server } = require('@uvue/server');

// Force production mode
process.env.NODE_ENV = 'production';

(async () => {
  // Load config from current project
  let options = {};
  if (await exists(resolve('server.config.js'))) {
    options = require(resolve('server.config.js'));
  }

  /**
   * Create server
   */
  const server = new Server({
    // Set files destinations
    paths: {
      outputDir: resolve('dist'), // TODO: find a way to configure this
      serverBundle: '.uvue/server-bundle.json',
      clientManifest: '.uvue/client-manifest.json',
      templates: {
        spa: '.uvue/spa.html',
        ssr: '.uvue/ssr.html',
      },
    },

    // Set server configuration
    httpOptions: {
      host,
      port,
      https: options.https,
    },
  });

  // Install plugins from config
  if (options.plugins) {
    for (const pluginDef of options.plugins) {
      if (typeof pluginDef === 'string') {
        const plugin = require(pluginDef);
        server.addPlugin(plugin.default || plugin, pluginDef[1]);
      } else if (Array.isArray(pluginDef)) {
        const plugin = require(pluginDef[0]);
        server.addPlugin(plugin.default || plugin, pluginDef[1]);
      }
    }
  }

  /**
   * Start server
   */
  await server.start();

  console.log(
    `Server listening: ${server.getAdapter().isHttps() ? 'https' : 'http'}://${host}:${port}`,
  );
})().catch(err => {
  console.error(err);
  process.exit(1);
});
